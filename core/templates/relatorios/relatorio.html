{% extends "base.html" %}

{% block titulo %}Relatório Financeiro{% endblock %}

{% block conteudo %}

<h2 class="mb-4">Relatório Financeiro</h2>

<!-- FILTROS -->
<form method="GET" class="row g-3 mb-4">

    <!-- Mês -->
    <div class="col-md-3">
        <label class="form-label">Mês</label>
        <select name="mes" class="form-select">
            <option value="">Todos</option>
            {% for numero, nome in meses %}
                {% with numero_str=numero|stringformat:"s" mes_req=request.GET.mes|stringformat:"s" %}
                    {% if mes_req == numero_str %}
                        <option value="{{ numero }}" selected>{{ nome }}</option>
                    {% else %}
                        <option value="{{ numero }}">{{ nome }}</option>
                    {% endif %}
                {% endwith %}
            {% endfor %}
        </select>
    </div>

    <!-- Ano -->
    <div class="col-md-3">
        <label class="form-label">Ano</label>
        <input type="number" name="ano" class="form-control"
               value="{{ request.GET.ano }}">
    </div>

    <!-- Data início -->
    <div class="col-md-3">
        <label class="form-label">Data inicial</label>
        <input type="date" name="data_inicio" class="form-control" 
               value="{{ request.GET.data_inicio }}">
    </div>

    <!-- Data fim -->
    <div class="col-md-3">
        <label class="form-label">Data final</label>
        <input type="date" name="data_fim" class="form-control" 
               value="{{ request.GET.data_fim }}">
    </div>

    <!-- Categoria -->
    <div class="col-md-3">
        <label class="form-label">Categoria</label>
        <select name="categoria" class="form-select">
            <option value="">Todas</option>
            {% for c in categorias %}
                {% with cid=c.id|stringformat:"s" creq=request.GET.categoria|stringformat:"s" %}
                    {% if cid == creq %}
                        <option selected value="{{ c.id }}">{{ c.nome }}</option>
                    {% else %}
                        <option value="{{ c.id }}">{{ c.nome }}</option>
                    {% endif %}
                {% endwith %}
            {% endfor %}
        </select>
    </div>

    <div class="col-12">
        <button class="btn btn-primary">Filtrar</button>
        <a href="{% url 'relatorio' %}" class="btn btn-secondary">Limpar</a>
    </div>
</form>

<!-- RESUMO -->
<div class="row mb-4">

    <div class="col-md-4">
        <div class="card border-success shadow-sm">
            <div class="card-body">
                <h5 class="text-success">Receitas</h5>
                <h3 class="fw-bold">R$ {{ total_receitas|floatformat:2 }}</h3>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card border-danger shadow-sm">
            <div class="card-body">
                <h5 class="text-danger">Despesas</h5>
                <h3 class="fw-bold">R$ {{ total_despesas|floatformat:2 }}</h3>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card border-primary shadow-sm">
            <div class="card-body">
                <h5 class="text-primary">Saldo</h5>
                <h3 class="fw-bold {% if saldo < 0 %}text-danger{% else %}text-success{% endif %}">
                    R$ {{ saldo|floatformat:2 }}
                </h3>
            </div>
        </div>
    </div>

</div>

<!-- TABELA -->
<table class="table table-striped table-hover">
    <thead class="table-dark">
        <tr>
            <th>Data</th>
            <th>Descrição</th>
            <th>Tipo</th>
            <th>Categoria</th>
            <th>Valor</th>
        </tr>
    </thead>
    <tbody>
        {% for t in transacoes %}
        <tr>
            <td>{{ t.data }}</td>
            <td>{{ t.descricao }}</td>
            <td>{{ t.tipo }}</td>
            <td>{{ t.categoria.nome }}</td>
            <td>R$ {{ t.valor|floatformat:2 }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="5" class="text-center text-muted">Nenhuma transação encontrada.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% endblock %}
